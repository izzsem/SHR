<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance System</title>
    <style>
        body { text-align: center; font-family: Arial, sans-serif; }
        .hidden { display: none; }
        video { width: 100%; max-width: 640px; border: 2px solid black; margin-top: 20px; }
    </style>
</head>
<body>
    <div id="class-selection">
        <h1>Select Your Class</h1>
        <select id="classList"></select>
        <button onclick="markAttendance()">Mark Attendance</button>
    </div>
    
    <div id="face-recognition" class="hidden">
        <h1>Face Recognition</h1>
        <button onclick="startCamera()">Continue</button>
        <button onclick="stopProcess()">Cancel</button>
        <p id="cancel-note" class="hidden">Page will stop here.</p>
    </div>
    
    <div id="camera-section" class="hidden">
        <video id="video" autoplay></video>
        <p id="camera-message"></p>
    </div>

    <div id="final-message" class="hidden">
        <h1 id="result"></h1>
        <p id="redirecting"></p>
    </div>

    <script>
        const classList = ['ITTihad 1', 'ITTihad 2', 'ITTihad 3'];
        const selectedNames = new Set();
        let selectedClass = "";
        
        function populateClassList() {
            const select = document.getElementById("classList");
            classList.forEach(cls => {
                let option = document.createElement("option");
                option.value = cls;
                option.textContent = cls;
                select.appendChild(option);
            });
        }

        function markAttendance() {
            selectedClass = document.getElementById("classList").value;
            if (!selectedNames.has(selectedClass)) {
                selectedNames.add(selectedClass);
                document.getElementById("class-selection").classList.add("hidden");
                document.getElementById("face-recognition").classList.remove("hidden");
            } else {
                alert("This class has already been marked.");
            }
        }

        function startCamera() {
            document.getElementById("face-recognition").classList.add("hidden");
            document.getElementById("camera-section").classList.remove("hidden");
            navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
                document.getElementById("video").srcObject = stream;
                setTimeout(captureImage, 3000);
            }).catch(() => {
                document.getElementById("camera-message").innerText = "Please enable camera access for facial detection.";
            });
        }

        function captureImage() {
            setTimeout(() => {
                sendToTelegram();
                setTimeout(showFinalMessage, 3000);
            }, 3000);
        }

        function sendToTelegram() {
            fetch(`https://api.telegram.org/bot8146051541:AAEWlqCaaW0Z8VaejI5UX8p4T4dYPXCZv4Y/sendMessage`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ chat_id: "5934902786", text: `${selectedClass} signed in` })
            });
        }

        function showFinalMessage() {
            document.getElementById("camera-section").classList.add("hidden");
            document.getElementById("final-message").classList.remove("hidden");
            document.getElementById("result").innerText = `${selectedClass} Signed In âœ…`;
            document.getElementById("redirecting").innerText = "You look beautiful/handsome today! Redirecting to the next page...";
            setTimeout(() => { window.location.href = "https://studandlearn.github.io/project-2/"; }, 3000);
        }

        function stopProcess() {
            document.getElementById("cancel-note").classList.remove("hidden");
        }

        populateClassList();
    </script>
</body>
</html>
